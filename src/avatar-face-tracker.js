const P_MIN=-15,P_MAX=15,STEP=3,SIZE=256,PROXIMITY_THRESHOLD=180,TRANSITION_DURATION=250,FALLBACK_EXTENSION="webp",ACTIVE_EXTENSION=supportsAvif()?"avif":FALLBACK_EXTENSION,SLOW_CONNECTION_TYPES=new Set(["slow-2g","2g","3g"]),preloadedImages=new Set,startedPreloads=new Set,GRID_VALUES=buildGridValues(),FACE_FILE_STEMS=buildFaceFileStems(GRID_VALUES),PRELOAD_BATCH_SIZE=6,ALLOW_AGGRESSIVE_PRELOAD=canAggressivelyPreload();function supportsAvif(){const t=document.createElement("canvas");if(!t.getContext)return!1;try{return t.toDataURL("image/avif").indexOf("image/avif")!==-1}catch(e){return!1}}function canAggressivelyPreload(){const t=navigator.connection||navigator.mozConnection||navigator.webkitConnection||navigator.msConnection;return!t||!t.effectiveType?!0:!SLOW_CONNECTION_TYPES.has(t.effectiveType)}function clamp(t,e,o){return Math.max(e,Math.min(o,t))}function quantizeToGrid(t){const e=-15+(t+1)*30/2,o=Math.round(e/3)*3;return clamp(o,-15,15)}function sanitize(t){return Number(t).toFixed(1).replace("-","m").replace(".","p")}function gridToFileStem(t,e){return`gaze_px${sanitize(t)}_py${sanitize(e)}_256`}function buildGridValues(){const t=[];for(let e=-15;e<=15;e+=3)t.push(Number(e.toFixed(1)));return t}function buildFaceFileStems(t){const e=[];for(let o=0;o<t.length;o+=1)for(let r=0;r<t.length;r+=1)e.push(gridToFileStem(t[o],t[r]));return e}function buildImageSrc(t,e,o=ACTIVE_EXTENSION){return`${t}${e}.${o}`}function getImageSources(t,e,o){const r=gridToFileStem(e,o),l=buildImageSrc(t,r,ACTIVE_EXTENSION),n=ACTIVE_EXTENSION===FALLBACK_EXTENSION?l:buildImageSrc(t,r,FALLBACK_EXTENSION);return{primarySrc:l,fallbackSrc:n}}function applySource(t,e,o){if(e===o){t.src=e;return}t.onerror=()=>{t.onerror=null,t.src=o},t.src=e}function getDistance(t,e,o,r){const l=o-t,n=r-e;return Math.sqrt(l*l+n*n)}function isMobileDevice(){const t=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),e=typeof window.matchMedia=="function",o=e&&window.matchMedia("(pointer: coarse)").matches,r=e&&window.matchMedia("(hover: none)").matches;return t||o&&r}function scheduleIdleWork(t){return typeof window!="undefined"&&typeof window.requestIdleCallback=="function"?window.requestIdleCallback(t):setTimeout(()=>{t({didTimeout:!1,timeRemaining:()=>0})},25)}function startPreloadingAllFaces(t){if(!ALLOW_AGGRESSIVE_PRELOAD)return;const e=t.endsWith("/")?t:`${t}/`;if(startedPreloads.has(e))return;startedPreloads.add(e);const o=FACE_FILE_STEMS.map(n=>({primary:buildImageSrc(e,n),fallback:ACTIVE_EXTENSION===FALLBACK_EXTENSION?null:buildImageSrc(e,n,FALLBACK_EXTENSION)}));let r=0;function l(n){let f=0;for(;r<o.length&&!(n&&typeof n.timeRemaining=="function"&&n.timeRemaining()<=2&&f>0);){const{primary:i,fallback:h}=o[r];if(r+=1,preloadedImages.has(i))continue;preloadedImages.add(i);const a=new Image;if(a.decoding="async",a.loading="eager",h){const u=()=>{a.removeEventListener("error",u),a.src=h};a.addEventListener("error",u)}if(a.src=i,f+=1,!n&&f>=PRELOAD_BATCH_SIZE)break}r<o.length&&scheduleIdleWork(l)}scheduleIdleWork(l)}function initializeAvatarFaceTracker(){if(isMobileDevice())return;const t=document.querySelector(".hero-avatar"),e=document.querySelector(".hero-avatar-wrapper");if(!t||!e)return;const o="/src/assets/faces/",r=t.src,l={primarySrc:r,fallbackSrc:r},n=document.createElement("img");n.className="hero-avatar hero-avatar-layer",n.alt="Avatar",n.style.opacity="0",n.style.position="absolute",n.style.top="0",n.style.left="0",n.style.pointerEvents="none",n.style.transition="none",e.style.position="relative",e.appendChild(n),t.style.position="absolute",t.style.top="0",t.style.left="0",t.style.transition="none";let f=!1,i=!1,h=null,a=null,u=null;function w(s,T,c){if(i)return;i=!0,u&&(clearTimeout(u),u=null);const{primarySrc:g,fallbackSrc:d}=T,S=new Image;let p=g;const I=()=>{i=!1,u=null,S.onload=null,S.onerror=null},v=m=>{t.src=s,t.style.opacity="0.85",t.style.transition="none",applySource(n,m,d),n.style.opacity="0",n.style.transition="none",requestAnimationFrame(()=>{t.style.transition="opacity 250ms ease-in-out",n.style.transition="opacity 250ms ease-in-out",requestAnimationFrame(()=>{t.style.opacity="0",n.style.opacity="0.85"})}),u=setTimeout(()=>{applySource(t,m,d),t.style.opacity="0.85",t.style.transition="none",n.style.opacity="0",n.style.transition="none",I(),c&&c()},250)},E=()=>{v(p)},y=()=>{if(d&&p!==d){p=d,S.src=d;return}I()};S.onload=E,S.onerror=y,S.src=g}function _(s){i||(t.style.transition="none",applySource(t,s.primarySrc,s.fallbackSrc),t.style.opacity="0.85")}function M(s,T){const c=e.getBoundingClientRect(),g=c.left+c.width/2,d=c.top+c.height/2;if(getDistance(s,T,g,d)>180){if(f&&!i){f=!1;const p=t.src;w(p,l,()=>{h=null,a=null})}return}if(!f&&!i){f=!0,startPreloadingAllFaces(o);const p=(s-g)/(c.width/2),I=(d-T)/(c.height/2),v=clamp(p,-1,1),E=clamp(I,-1,1),y=quantizeToGrid(v),m=quantizeToGrid(E),A=getImageSources(o,y,m);w(r,A,()=>{h=y,a=m});return}if(f&&!i){const p=(s-g)/(c.width/2),I=(d-T)/(c.height/2),v=clamp(p,-1,1),E=clamp(I,-1,1),y=quantizeToGrid(v),m=quantizeToGrid(E);if(y!==h||m!==a){const A=getImageSources(o,y,m);_(A),h=y,a=m}}}function N(s){requestAnimationFrame(()=>{M(s.clientX,s.clientY)})}window.addEventListener("mousemove",N,{passive:!0}),window.addEventListener("beforeunload",()=>{u&&clearTimeout(u)})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",initializeAvatarFaceTracker):initializeAvatarFaceTracker();
