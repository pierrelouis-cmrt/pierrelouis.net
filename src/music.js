"use strict";var d;const USER="pierrelouis-c",INTERVALS={playing:15e3,idle:6e4,hidden:12e4},REQUEST_TIMEOUT_MS=8e3,LASTFM_PROXY_PATH="/api/lastfm.php",IMAGE_SIZE="large",IMG_PROXY_PATH="/api/img.php",COVER_DISPLAY_WIDTH=75,titleEl=document.querySelector(".music-widget .music-track-title"),artistEl=document.querySelector(".music-widget .music-track-artist"),coverEl=document.querySelector(".music-widget .music-album-cover"),statusEl=document.querySelector(".music-widget .music-player-status"),defaultCoverSvg=(d=coverEl==null?void 0:coverEl.innerHTML)!=null?d:"",hasMusicWidgetDom=!!(titleEl&&artistEl&&coverEl&&statusEl);let currentTrackKey=null,pollTimerId=null,currentController=null;const coverCache=new Map,inflightCover=new Map,lastRendered={title:"",artist:"",cover:"",url:""},sleep=t=>new Promise(n=>setTimeout(n,t));function trackKeyFrom(t){var e,o,s,c,l,a,u,m,f;const n=(s=(o=(e=t==null?void 0:t.artist)==null?void 0:e["#text"])==null?void 0:o.trim())!=null?s:"",i=(l=(c=t==null?void 0:t.name)==null?void 0:c.trim())!=null?l:"";return((f=(m=(a=t==null?void 0:t.mbid)==null?void 0:a.trim())!=null?m:(u=t==null?void 0:t.mbid)==null?void 0:u.trim())!=null?f:"")||`${n.toLowerCase()}\u2014${i.toLowerCase()}`}function lastNonEmptyImageUrl(t){var n,i,r;if(!Array.isArray(t))return"";for(let e=t.length-1;e>=0;e--){const o=(r=(i=(n=t[e])==null?void 0:n["#text"])==null?void 0:i.trim())!=null?r:"";if(o)return o}return""}function imageUrlBySize(t,n){var e,o;if(!Array.isArray(t))return"";const i=t.find(s=>(s==null?void 0:s.size)===n);return((o=(e=i==null?void 0:i["#text"])==null?void 0:e.trim())!=null?o:"")||lastNonEmptyImageUrl(t)}function looksLikeLastfmPlaceholder(t){return t?t.includes("2a96cbd8b46e442fc41c2b86b821562f.png"):!0}async function fetchJsonWithRetry(t,{retries:n=2,backoffBase:i=500}={}){let r=0;for(;;){r++;const e=new AbortController,o=setTimeout(()=>e.abort(),REQUEST_TIMEOUT_MS);try{const s=await fetch(t,{signal:e.signal,cache:"no-store"});if(!s.ok&&(s.status===429||s.status>=500&&s.status<600)&&r<=n+1)throw new Error(`HTTP ${s.status}`);return await s.json()}catch(s){if(r>n+1)throw s;const c=i*2**(r-1)+Math.floor(Math.random()*200);await sleep(c)}finally{clearTimeout(o)}}}function proxyUrl(t,n=COVER_DISPLAY_WIDTH,i=1,r="jpeg",e=80){const o=new URL(IMG_PROXY_PATH,window.location.origin);return o.searchParams.set("src",t),o.searchParams.set("w",String(n)),o.searchParams.set("dpr",String(Math.max(1,Math.min(3,Math.round(i))))),o.searchParams.set("fmt",r),o.searchParams.set("q",String(e)),o.pathname+o.search}function preloadImage(t){return new Promise(n=>{if(!t||looksLikeLastfmPlaceholder(t))return n(null);const i=new Image;i.onload=()=>n(t),i.onerror=()=>n(null),i.src=t})}async function getRecentNowPlaying(){var s,c;const t=new URLSearchParams({endpoint:"now-playing"}),n=`${LASTFM_PROXY_PATH}?${t.toString()}`,i=await fetchJsonWithRetry(n,{retries:2}),r=(s=i==null?void 0:i.recenttracks)==null?void 0:s.track;if(!Array.isArray(r)||r.length===0)return null;const e=r[0];return((c=e==null?void 0:e["@attr"])==null?void 0:c.nowplaying)==="true"?e:null}async function getTrackInfoCover(t,n){var a,u;const i=new URLSearchParams({endpoint:"cover",artist:t,track:n}),r=`${LASTFM_PROXY_PATH}?${i.toString()}`,e=await fetchJsonWithRetry(r,{retries:2}),o=(u=(a=e==null?void 0:e.track)==null?void 0:a.album)==null?void 0:u.image,s=imageUrlBySize(o,IMAGE_SIZE),c=s?proxyUrl(s,COVER_DISPLAY_WIDTH,1,"jpeg",80):"";return await preloadImage(c)?s:null}function setLink(t,n,i){if(!t)return;let r=t.querySelector("a");r||(r=document.createElement("a"),r.target="_blank",r.rel="noopener",t.replaceChildren(r)),r.textContent!==n&&(r.textContent=n),r.href!==i&&(r.href=i)}function setText(t,n){t&&t.textContent!==n&&(t.textContent=n)}function setCover(t){if(!coverEl)return;if(!t){coverEl.innerHTML!==defaultCoverSvg&&(coverEl.innerHTML=defaultCoverSvg);return}const n=coverEl.querySelector("img"),i=proxyUrl(t,COVER_DISPLAY_WIDTH,1,"jpeg",80),r=proxyUrl(t,COVER_DISPLAY_WIDTH,2,"jpeg",80);if(n){const e=`${i} 1x, ${r} 2x`;(n.src!==i||n.srcset!==e)&&(n.src=i,n.srcset=e,n.alt="Album art",n.width=COVER_DISPLAY_WIDTH,n.height=COVER_DISPLAY_WIDTH,n.decoding="async")}else{const e=document.createElement("img");e.src=i,e.srcset=`${i} 1x, ${r} 2x`,e.alt="Album art",e.width=COVER_DISPLAY_WIDTH,e.height=COVER_DISPLAY_WIDTH,e.decoding="async",coverEl.replaceChildren(e)}}function showStatus(t){if(!statusEl)return;const n=t?"flex":"none";statusEl.style.display!==n&&(statusEl.style.display=n)}async function resolveCoverForTrack(t){var s,c,l;const n=(c=(s=t==null?void 0:t.artist)==null?void 0:s["#text"])!=null?c:"",i=(l=t==null?void 0:t.name)!=null?l:"",r=trackKeyFrom(t);if(coverCache.has(r))return coverCache.get(r);const e=imageUrlBySize(t==null?void 0:t.image,IMAGE_SIZE);return await preloadImage(e?proxyUrl(e,COVER_DISPLAY_WIDTH,1,"jpeg",80):"")?(coverCache.set(r,e),e):(inflightCover.has(r)||inflightCover.set(r,(async()=>{const a=await getTrackInfoCover(n,i);return a&&coverCache.set(r,a),a})().finally(()=>{setTimeout(()=>inflightCover.delete(r),0)})),await inflightCover.get(r))}function nextInterval({isPlaying:t}){return document.hidden?INTERVALS.hidden:t?INTERVALS.playing:INTERVALS.idle}function scheduleNext(t){clearTimeout(pollTimerId),pollTimerId=setTimeout(pollOnce,t)}async function pollOnce(){var t,n,i,r;currentController&&currentController.abort(),currentController=new AbortController;try{const e=await getRecentNowPlaying();if(!e){currentTrackKey!==null&&(currentTrackKey=null),setText(titleEl,"Nothing right now"),setText(artistEl,"I'm not currently listening to any music"),setCover(null),showStatus(!1),scheduleNext(nextInterval({isPlaying:!1}));return}const o=trackKeyFrom(e),s=(n=(t=e==null?void 0:e.artist)==null?void 0:t["#text"])!=null?n:"",c=(i=e==null?void 0:e.name)!=null?i:"",l=(r=e==null?void 0:e.url)!=null?r:"#",a=o!==currentTrackKey;currentTrackKey=o,(a||lastRendered.title!==c||lastRendered.url!==l)&&(setLink(titleEl,c,l),lastRendered.title=c,lastRendered.url=l),(a||lastRendered.artist!==s)&&(setText(artistEl,s),lastRendered.artist=s);const u=await resolveCoverForTrack(e);(a||lastRendered.cover!==(u||""))&&(setCover(u||null),lastRendered.cover=u||""),showStatus(!0),scheduleNext(nextInterval({isPlaying:!0}))}catch(e){scheduleNext(Math.min(12e4,INTERVALS.idle*2))}}hasMusicWidgetDom&&(document.addEventListener("visibilitychange",()=>{scheduleNext(nextInterval({isPlaying:currentTrackKey!==null}))}),pollOnce());
