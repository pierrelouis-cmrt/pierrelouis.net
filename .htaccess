# Enable mod_rewrite
RewriteEngine On

# Redirect `/index.html` to the canonical root URL
RewriteCond %{THE_REQUEST} /index\.html [NC]
RewriteRule ^(.*/)?index\.html$ /$1 [R=301,L]

# Enforce HTTPS and non-www hostname
RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
RewriteRule ^ https://%1%{REQUEST_URI} [R=301,L]
RewriteCond %{HTTPS} off
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]

# Map clean endpoints to your PHP proxy
RewriteRule "^api/now-playing$" "/api/lastfm.php?endpoint=now-playing" [QSA,L]
RewriteRule "^api/cover$"       "/api/lastfm.php?endpoint=cover"       [QSA,L]
RewriteRule "^img$"             "/api/img.php"                         [QSA,L]

# --- MIME types ---
AddType image/avif avif
AddType image/webp webp

# --- Security & Caching Headers ---
<IfModule mod_headers.c>
  # 1. SECURITY HEADERS (Added these for you)
  # Force HTTPS for 1 year (HSTS) - prevent downgrade attacks
  Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
  # Prevent your site from being embedded in iframes (prevents clickjacking)
  Header always set X-Frame-Options "SAMEORIGIN"
  # Stop browsers from guessing content types (prevents MIME-sniffing exploits)
  Header always set X-Content-Type-Options "nosniff"
  # Basic XSS protection for older browsers
  Header always set X-XSS-Protection "1; mode=block"
  # Referrer Policy (Privacy best practice)
  Header always set Referrer-Policy "strict-origin-when-cross-origin"

  # 2. CACHING HEADERS
  # HTML: Never cache dynamic content
  <FilesMatch "\.(?:html|php)$">
    Header always unset Cache-Control
    Header always unset Expires
    Header always unset Pragma
    Header always set Cache-Control "no-store, no-cache, must-revalidate"
  </FilesMatch>

  # Static Assets: Cache for 1 year
  <FilesMatch "\.(?:css|js|mjs|ico|woff2?|ttf|eot|gif|png|jpe?g|webp|avif|svg)$">
    Header always unset Cache-Control
    Header always unset Expires
    Header always unset Pragma
    Header always set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>
</IfModule>

# Disable legacy mod_expires if acceptable (cleaner to manage headers in one place above)
<IfModule mod_expires.c>
  ExpiresActive Off
</IfModule>